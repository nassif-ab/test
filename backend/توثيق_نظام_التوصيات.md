# توثيق نظام التوصيات

## مقدمة

هذا المستند يشرح كيفية عمل نظام التوصيات المُنفذ في تطبيق المدونة. يستخدم النظام تقنيات التصفية التعاونية وتحليل المحتوى لتقديم توصيات مخصصة للمستخدمين بناءً على تفاعلاتهم السابقة.

## بنية النظام

يتكون نظام التوصيات من المكونات التالية:

1. **فئة RecommendationSystem**: مُنفذة في ملف `RecommendationSystem.py`، تحتوي هذه الفئة على كل المنطق اللازم لإنشاء التوصيات.
2. **نقاط نهاية API**: مُنفذة في `routers/posts.py`، تسمح نقاط النهاية هذه لتطبيق الواجهة الأمامية بطلب التوصيات.
3. **نص برمجي للتدريب**: يسمح ملف `train_recommendation_system.py` بتدريب واختبار النظام باستخدام البيانات الموجودة.

## خوارزمية التوصيات

### 1. التوصيات المخصصة للمستخدمين

تستخدم الخوارزمية نهجًا هجينًا يجمع بين:

#### أ) التصفية التعاونية مع SVD (تحليل القيم المفردة)

```python
def _build_user_item_matrix(self):
    # بناء مصفوفة تفاعلات المستخدم-العنصر
    # الصفوف: المستخدمين، الأعمدة: المنشورات
    # القيم: وزن التفاعلات (الإعجابات = 2، الزيارات = 1)
```

```python
def _apply_svd(self, matrix, n_components = 10):
    # تطبيق SVD لتقليل الأبعاد واكتشاف الأنماط الكامنة
    svd = TruncatedSVD(n_components=n_components)
    matrix_reduced = svd.fit_transform(matrix)
    reconstructed_matrix = matrix_reduced @ svd.components_
```

#### ب) تحليل التفضيلات حسب الفئة

```python
# عد التفاعلات حسب الفئة
category_weights = defaultdict(int)
for post in interacted_posts:
    # إعطاء وزن أكبر للإعجابات (×3) من الزيارات (×1)
    like_weight = 3 if post.id in [like.post_id for like in user_likes] else 0
    visit_weight = 1 if post.id in [visit.post_id for visit in user_visits] else 0
    category_weights[post.categorie] += (like_weight + visit_weight)
```

#### ج) النتيجة المركبة

```python
# حساب النتيجة المركبة (SVD + الفئة)
combined_score = svd_score + category_bonus
```

### 2. توصيات المنشورات المشابهة

للعثور على منشورات مشابهة لمنشور معين، يقوم النظام بـ:

1. البحث أولاً عن منشورات من نفس الفئة
2. إذا لم تكن هناك منشورات كافية، يستخدم تشابه جيب التمام بناءً على الفئات

```python
# تصفية المنشورات حسب الفئة إذا كانت متاحة
if post.categorie:
    category_posts = [p for p in all_posts if p.categorie == post.categorie and p.id != post_id]
```

## آلية التخزين المؤقت

لتحسين الأداء، ينفذ النظام آلية تخزين مؤقت:

```python
# ذاكرة التخزين المؤقت لنتائج التوصيات
self.user_based_recommendations_cache = {}
self.content_based_recommendations_cache = {}
self.similar_posts_cache = {}
# متى تم تحديث التخزين المؤقت آخر مرة
self.last_cache_update = datetime.datetime.now()
# وقت انتهاء صلاحية التخزين المؤقت (12 ساعة)
self.cache_expiry = datetime.timedelta(hours=12)
```

## كيفية تفعيل التوصيات

### 1. تدريب النظام

لتدريب النظام وتحديث التوصيات، قم بتنفيذ:

```bash
cd backend
.\venv\Scripts\activate
python train_recommendation_system.py
```

هذا النص البرمجي:
- يبطل التخزين المؤقت للتوصيات
- يحلل التفاعلات الموجودة في قاعدة البيانات
- ينشئ توصيات جديدة بناءً على البيانات الحالية

### 2. الاستخدام في التطبيق

#### أ) التوصيات للمستخدمين

يتم الحصول على التوصيات المخصصة من خلال نقطة النهاية:

```
GET /api/posts/user/{user_id}/recommendations
```

تعيد نقطة النهاية هذه قائمة بالمنشورات الموصى بها للمستخدم المحدد.

#### ب) المنشورات المشابهة

للحصول على منشورات مشابهة لمنشور معين، يتم استخدام نقطة النهاية:

```
GET /api/posts/{post_id}/similar
```

تعيد نقطة النهاية هذه قائمة بالمنشورات المشابهة للمنشور المحدد.

## أفضل الممارسات

1. **التدريب بانتظام**: قم بتنفيذ `train_recommendation_system.py` بشكل دوري للحفاظ على تحديث التوصيات.

2. **تشجيع التفاعلات**: كلما زادت التفاعلات (الإعجابات والزيارات)، كانت التوصيات أفضل.

3. **التصنيف بشكل صحيح**: تأكد من أن جميع المنشورات لها فئة محددة لتحسين دقة التوصيات.

## حل المشكلات

### التوصيات غير ذات الصلة

إذا لم تبدو التوصيات ذات صلة:

1. تحقق من أن المستخدم لديه تفاعلات كافية (إعجابات وزيارات)
2. قم بتنفيذ `train_recommendation_system.py` لتحديث النظام
3. تأكد من أن المنشورات لها فئات محددة بشكل صحيح

### خطأ "المصفوفة صغيرة جدًا لـ SVD"

تظهر هذه الرسالة عندما لا تكون هناك بيانات كافية لتطبيق SVD. في هذه الحالة، سيستخدم النظام طرقًا بديلة:

1. توصيات تستند إلى الفئات المفضلة
2. المنشورات الشائعة كحل بديل

## الخلاصة

تم تصميم نظام التوصيات ليتحسن مع مرور الوقت كلما تفاعل المستخدمون أكثر مع المدونة. تصبح التوصيات أكثر دقة وتخصيصًا مع كل تفاعل إضافي.
