# توثيق نظام التوصيات

## مقدمة

هذا المستند يشرح كيفية عمل نظام التوصيات المُنفذ في تطبيق المدونة. يستخدم النظام تقنيات التصفية التعاونية وتحليل المحتوى لتقديم توصيات مخصصة للمستخدمين بناءً على تفاعلاتهم السابقة.

## بنية النظام

يتكون نظام التوصيات من المكونات التالية:

1. **فئة RecommendationSystem**: مُنفذة في ملف `RecommendationSystem.py`، تحتوي هذه الفئة على كل المنطق اللازم لإنشاء التوصيات.
2. **نقاط نهاية API**: مُنفذة في `routers/posts.py`، تسمح نقاط النهاية هذه لتطبيق الواجهة الأمامية بطلب التوصيات.
3. **نص برمجي للتدريب**: يسمح ملف `train_recommendation_system.py` بتدريب واختبار النظام باستخدام البيانات الموجودة.

## خوارزمية التوصيات

### 1. التوصيات المخصصة للمستخدمين

تستخدم الخوارزمية نهجًا هجينًا يجمع بين:

#### أ) التصفية التعاونية مع SVD (تحليل القيم المفردة)

```python
def _build_user_item_matrix(self):
    # بناء مصفوفة تفاعلات المستخدم-العنصر
    # الصفوف: المستخدمين، الأعمدة: المنشورات
    # القيم: وزن التفاعلات (الإعجابات = 2، الزيارات = 1)
```

```python
def _apply_svd(self, matrix, n_components = 10):
    # تطبيق SVD لتقليل الأبعاد واكتشاف الأنماط الكامنة
    svd = TruncatedSVD(n_components=n_components)
    matrix_reduced = svd.fit_transform(matrix)
    reconstructed_matrix = matrix_reduced @ svd.components_
```

#### ب) تحليل التفضيلات حسب الفئة

```python
# عد التفاعلات حسب الفئة
category_weights = defaultdict(int)
for post in interacted_posts:
    # إعطاء وزن أكبر للإعجابات (×3) من الزيارات (×1)
    like_weight = 3 if post.id in [like.post_id for like in user_likes] else 0
    visit_weight = 1 if post.id in [visit.post_id for visit in user_visits] else 0
    category_weights[post.categorie] += (like_weight + visit_weight)
```

#### ج) النتيجة المركبة

```python
# حساب النتيجة المركبة (SVD + الفئة)
combined_score = svd_score + category_bonus
```

### 2. التوصيات المستندة على المحتوى (Content-Based)

تستخدم هذه الطريقة لاقتراح منشورات مشابهة لمنشور معين. تم تحسين الخوارزمية لتستخدم نهجًا متعدد المستويات:

1. **تحليل التفاعلات باستخدام SVD**: تحليل الإعجابات والزيارات للعثور على المنشورات التي تفاعل معها نفس المستخدمين الذين تفاعلوا مع المنشور الحالي.

2. **تحليل السمات المتقدم**: تستخدم مزيجًا من الفئات، طول العنوان، وطول المحتوى لحساب التشابه بين المنشورات باستخدام تشابه جيب التمام (cosine similarity).

3. **الفئات المتشابهة**: إذا لم تنجح الطرق السابقة، نستخدم الفئات للعثور على منشورات مشابهة.

4. **المنشورات الأحدث**: كملاذ أخير، نقترح المنشورات الأحدث.

```python
# تصفية المنشورات حسب الفئة إذا كانت متاحة
if post.categorie:
    category_posts = [p for p in all_posts if p.categorie == post.categorie and p.id != post_id]
```

## آلية التخزين المؤقت

لتحسين الأداء، ينفذ النظام آلية تخزين مؤقت:

```python
# ذاكرة التخزين المؤقت لنتائج التوصيات
self.user_based_recommendations_cache = {}
self.content_based_recommendations_cache = {}
self.similar_posts_cache = {}
# متى تم تحديث التخزين المؤقت آخر مرة
self.last_cache_update = datetime.datetime.now()
# وقت انتهاء صلاحية التخزين المؤقت (12 ساعة)
self.cache_expiry = datetime.timedelta(hours=12)
```

## كيفية تفعيل التوصيات

### 1. التحديث التلقائي للتوصيات

تم تعديل النظام ليحدث التوصيات تلقائيًا مع كل تفاعل جديد للمستخدم:

- عندما يقوم المستخدم بالإعجاب بمنشور، يتم تحديث توصياته فورًا
- عندما يزور المستخدم منشورًا، يتم تحديث توصياته فورًا
- عند زيارة منشور، يتم أيضًا تحديث قائمة المنشورات المشابهة لهذا المنشور

هذا يعني أن التوصيات تتحسن بشكل مستمر مع كل تفاعل جديد، دون الحاجة إلى تدريب يدوي.

### 2. التدريب اليدوي (اختياري)

يمكنك أيضًا تشغيل التدريب اليدوي لتحديث جميع التوصيات دفعة واحدة:

```bash
cd backend
.\venv\Scripts\activate
python train_recommendation_system.py
```

هذا النص البرمجي:
- يبطل التخزين المؤقت لجميع التوصيات
- يحلل جميع التفاعلات الموجودة في قاعدة البيانات
- ينشئ توصيات جديدة لجميع المستخدمين والمنشورات

### 2. الاستخدام في التطبيق

#### أ) التوصيات للمستخدمين

يتم الحصول على التوصيات المخصصة من خلال نقطة النهاية:

```
GET /api/posts/user/{user_id}/recommendations
```

تعيد نقطة النهاية هذه قائمة بالمنشورات الموصى بها للمستخدم المحدد.

#### ب) المنشورات المشابهة

للحصول على منشورات مشابهة لمنشور معين، يتم استخدام نقطة النهاية:

```
GET /api/posts/{post_id}/similar
```

تعيد نقطة النهاية هذه قائمة بالمنشورات المشابهة للمنشور المحدد.

## أفضل الممارسات

1. **التدريب بانتظام**: قم بتنفيذ `train_recommendation_system.py` بشكل دوري للحفاظ على تحديث التوصيات.

2. **تشجيع التفاعلات**: كلما زادت التفاعلات (الإعجابات والزيارات)، كانت التوصيات أفضل.

3. **التصنيف بشكل صحيح**: تأكد من أن جميع المنشورات لها فئة محددة لتحسين دقة التوصيات.

## حل المشكلات

### التوصيات غير ذات الصلة

إذا لم تبدو التوصيات ذات صلة:

1. تحقق من أن المستخدم لديه تفاعلات كافية (إعجابات وزيارات)
2. قم بتنفيذ `train_recommendation_system.py` لتحديث النظام
3. تأكد من أن المنشورات لها فئات محددة بشكل صحيح

### خطأ "المصفوفة صغيرة جدًا لـ SVD"

تظهر هذه الرسالة عندما لا تكون هناك بيانات كافية لتطبيق SVD. في هذه الحالة، سيستخدم النظام طرقًا بديلة:

1. توصيات تستند إلى الفئات المفضلة
2. المنشورات الشائعة كحل بديل

## الخلاصة

تم تصميم نظام التوصيات ليتحسن مع مرور الوقت كلما تفاعل المستخدمون أكثر مع المدونة. تصبح التوصيات أكثر دقة وتخصيصًا مع كل تفاعل إضافي.

## إنشاء وتعبئة قاعدة البيانات

### إنشاء قاعدة البيانات

لإنشاء قاعدة البيانات، اتبع الخطوات التالية:

1. تأكد من تثبيت جميع المتطلبات باستخدام الأمر:
   ```bash
   pip install -r requirements.txt
   ```

2. قم بتشغيل سكريبت إنشاء قاعدة البيانات:
   ```bash
   python create_db.py
   ```
   هذا السكريبت سينشئ جميع الجداول اللازمة في قاعدة البيانات استنادًا إلى النماذج المعرفة في `models.py`.

### تعبئة قاعدة البيانات بالبيانات الأولية

بعد إنشاء قاعدة البيانات، يمكنك تعبئتها بالبيانات الأولية باستخدام سكريبت `seed_dataV2.py`:

```bash
python seed_dataV2.py
```

هذا السكريبت سيقوم بما يلي:

1. إنشاء مستخدم مسؤول (admin) بالبيانات التالية:
   - اسم المستخدم: `admin`
   - كلمة المرور: `123456789`
   - البريد الإلكتروني: `admin@example.com`
   - صلاحيات المسؤول: `True`

2. إضافة مجموعة من المقالات المتنوعة في مختلف المجالات التقنية والهندسية.

### إنشاء مستخدم مسؤول يدويًا

إذا كنت ترغب في إنشاء مستخدم مسؤول جديد، يمكنك استخدام سكريبت `create_user.py`:

```bash
python create_user.py
```

هذا السكريبت يقوم بإنشاء مستخدم مسؤول بنفس البيانات المذكورة أعلاه.

### ملاحظات هامة

- تأكد من تشغيل هذه السكريبتات في المجلد الرئيسي للتطبيق.
- يجب أن تكون متغيرات البيئة مضبوطة بشكل صحيح في ملف `.env` أو في بيئة التشغيل.
- إذا واجهت أي أخطاء متعلقة بالإصدارات، تأكد من استخدام الإصدارات المتوافقة من المكتبات المذكورة في `requirements.txt`.

## واجهة برمجة التطبيقات (API) لتحليل البيانات

يوفر النظام واجهة برمجة تطبيقات خاصة لتحليل البيانات واستخدامها في أدوات الذكاء الأعمال مثل Power BI. هذه الواجهة توفر بيانات شاملة عن المستخدمين والمنشورات والتفاعلات.

### نقطة نهاية تحليل البيانات العامة

**المسار:** `/api/users/analytics/power-bi`

**الطريقة:** GET

**المصادقة المطلوبة:** نعم (يجب توفير مفتاح API صالح)

**الوصف:** توفر هذه النقطة بيانات شاملة للتحليل في Power BI أو أي أداة تحليل بيانات أخرى. تتضمن البيانات المرجعة:

- **بيانات المستخدمين:** معلومات عن جميع المستخدمين مع إحصائيات نشاطهم
- **بيانات المنشورات:** تفاصيل جميع المنشورات مع إحصائيات الإعجابات والزيارات
- **بيانات الإعجابات:** سجلات جميع الإعجابات التي قام بها المستخدمون
- **بيانات الزيارات:** سجلات جميع الزيارات للمنشورات
- **إحصائيات الفئات:** تحليل للفئات المختلفة ومستوى التفاعل معها
- **النشاط اليومي:** إحصائيات النشاط على مدى آخر 30 يومًا

**مثال للاستخدام مع Power BI:**

1. في Power BI، استخدم خيار "Get data" واختر "Web API"
2. أدخل الرابط: `http://localhost:8000/api/users/analytics/power-bi?api_key=pfe2025_test`
3. لاحظ أن مفتاح API المستخدم هو `pfe2025_test`
4. بعد استيراد البيانات، يمكنك إنشاء لوحات معلومات وتقارير تفاعلية لتحليل أداء المنصة
